title = "Edit Student"
url = "/students/:id/edit"
layout = "default"
is_hidden = 0
==
<?php
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\Validator;
use Winter\Storm\Exception\ValidationException;

function onStart()
{
    $this['studentsReady'] = Schema::hasTable('latihan_students');
    if (!$this['studentsReady']) {
        $this['student'] = null;
        return;
    }

    $id = (int) $this->param('id');
    $student = Db::table('latihan_students')->where('id', $id)->first();
    if (!$student) {
        Flash::error('Student tidak ditemukan.');
        return Redirect::to($this->pageUrl('students'));
    }

    $this['student'] = $student;
}

function onSave()
{
    if (!Schema::hasTable('latihan_students')) {
        Flash::error('Tabel latihan_students belum tersedia.');
        return;
    }

    $id = (int) $this->param('id');
    $student = Db::table('latihan_students')->where('id', $id)->first();
    if (!$student) {
        Flash::error('Student tidak ditemukan.');
        return;
    }

    $data = [
        'name' => trim((string) post('name')),
        'subject' => trim((string) post('subject')),
        'is_active' => post('is_active') ? 1 : 0,
    ];

    $validator = Validator::make($data, [
        'name' => 'required|string|max:255|unique:latihan_students,name,'.$id,
        'subject' => 'required|string|max:255',
        'is_active' => 'boolean',
    ], [
        'name.required' => '{{name_required}}',
        'name.unique' => '{{name_duplicate}}',
        'subject.required' => '{{subject_required}}',
    ]);

    if ($validator->fails()) {
        throw new ValidationException($validator);
    }

    Db::table('latihan_students')->where('id', $id)->update([
        'name' => $data['name'],
        'subject' => $data['subject'],
        'is_active' => $data['is_active'],
        'updated_at' => date('Y-m-d H:i:s'),
    ]);

    Flash::success('{{flash_student_saved}}');
}
?>
==
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
  <div>
    <h3 class="fw-bold mb-1" data-i18n="edit_student">Edit Student</h3>
    <p class="text-muted mb-0" data-i18n="edit_student_desc">Perbarui data student.</p>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ 'students'|page }}">
      <i class="bi bi-arrow-left me-1"></i> <span data-i18n="back">Back</span>
    </a>
  </div>
</div>

{% if not studentsReady %}
  <div class="alert alert-warning">
    Tabel <code>latihan_students</code> belum ada. Jalankan migration plugin <code>Latihan.Latihan</code> dulu.
  </div>
{% else %}
  {% partial "students/form" mode="edit" %}
{% endif %}