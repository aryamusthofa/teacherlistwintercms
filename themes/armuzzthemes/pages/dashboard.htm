title = "Dashboard"
url = "/dashboard"
layout = "default"
is_hidden = 0
==
<?php
use Illuminate\Support\Facades\Schema;

function onStart()
{
    $this['teachersReady'] = Schema::hasTable('latihan_teachers');

    if (!$this['teachersReady']) {
        $this['teacherStats'] = [
            'total' => 0,
            'active' => 0,
            'inactive' => 0,
        ];
        $this['recentTeachers'] = [];
        $this['subjectData'] = [];
        $this['timelineData'] = [];
        return;
    }

    $total = Db::table('latihan_teachers')->count();
    $active = Db::table('latihan_teachers')->where('is_active', 1)->count();
    $inactive = max(0, $total - $active);

    $this['teacherStats'] = compact('total', 'active', 'inactive');
    $this['recentTeachers'] = Db::table('latihan_teachers')->orderByDesc('id')->limit(5)->get();

    // Data for Subject Distribution chart (pie/doughnut)
    $subjects = Db::table('latihan_teachers')
        ->select(Db::raw('subject, COUNT(*) as cnt'))
        ->groupBy('subject')
        ->orderByDesc('cnt')
        ->limit(8)
        ->get();
    $this['subjectData'] = $subjects;

    // Data for Timeline chart (teachers created per day, last 7 days)
    $timeline = Db::table('latihan_teachers')
        ->select(Db::raw("DATE(created_at) as day, COUNT(*) as cnt"))
        ->where('created_at', '>=', date('Y-m-d', strtotime('-6 days')))
        ->groupBy('day')
        ->orderBy('day')
        ->get();
    $this['timelineData'] = $timeline;
}
?>
==
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
  <div>
    <h3 class="fw-bold mb-1" data-i18n="dashboard">Dashboard</h3>
    <p class="text-muted mb-0" data-i18n="dash_desc">Data summary & quick access.</p>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ 'teachers'|page }}">
      <i class="bi bi-people me-1"></i> <span data-i18n="teachers">Teachers</span>
    </a>
    <a class="btn btn-primary" href="{{ 'teachers_create'|page }}">
      <i class="bi bi-plus-lg me-1"></i> <span data-i18n="add_teacher">Add Teacher</span>
    </a>
  </div>
</div>

{% if not teachersReady %}
  <div class="alert alert-warning mb-4">
    Tabel <code>latihan_teachers</code> belum ada. Jalankan migration plugin <code>Latihan.Latihan</code> dulu.
  </div>
{% endif %}

<!-- ═══ Stat Cards ═══ -->
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card shadow-sm stat-card stat-total">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="stat-label" data-i18n="total_teachers">Total Teachers</div>
            <div class="stat-number">{{ teacherStats.total }}</div>
          </div>
          <div class="stat-icon"><i class="bi bi-people"></i></div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm stat-card stat-active">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="stat-label" data-i18n="active">Active</div>
            <div class="stat-number">{{ teacherStats.active }}</div>
          </div>
          <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm stat-card stat-inactive">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="stat-label" data-i18n="inactive">Inactive</div>
            <div class="stat-number">{{ teacherStats.inactive }}</div>
          </div>
          <div class="stat-icon"><i class="bi bi-slash-circle"></i></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ═══ Charts Row ═══ -->
<div class="row g-3 mb-4">
  <div class="col-md-7">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-transparent d-flex align-items-center gap-2">
        <i class="bi bi-bar-chart text-primary"></i>
        <span class="fw-semibold" data-i18n="chart_timeline">Teachers Added (Last 7 Days)</span>
      </div>
      <div class="card-body d-flex align-items-center justify-content-center" style="min-height:260px">
        <canvas id="timelineChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-5">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-transparent d-flex align-items-center gap-2">
        <i class="bi bi-pie-chart text-primary"></i>
        <span class="fw-semibold" data-i18n="chart_subjects">Subject Distribution</span>
      </div>
      <div class="card-body d-flex align-items-center justify-content-center" style="min-height:260px">
        <canvas id="subjectChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- ═══ Active vs Inactive (horizontal bar) ═══ -->
<div class="row g-3 mb-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-transparent d-flex align-items-center gap-2">
        <i class="bi bi-graph-up text-primary"></i>
        <span class="fw-semibold" data-i18n="chart_status">Active vs Inactive Overview</span>
      </div>
      <div class="card-body" style="max-height:200px">
        <canvas id="statusChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- ═══ Recent Teachers Table ═══ -->
<div class="card shadow-sm">
  <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
    <div class="fw-semibold" data-i18n="recent_teachers">Recent Teachers</div>
    <a class="btn btn-sm btn-outline-primary" href="{{ 'teachers'|page }}" data-i18n="view_all">View all</a>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th data-i18n="col_name">Name</th>
            <th data-i18n="col_subject">Subject</th>
            <th data-i18n="col_created">Created At</th>
            <th data-i18n="col_updated">Updated At</th>
            <th data-i18n="col_status">Status</th>
            <th class="text-end" data-i18n="col_action">Action</th>
          </tr>
        </thead>
        <tbody>
          {% if recentTeachers|length == 0 %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4" data-i18n="no_data">No data.</td>
            </tr>
          {% endif %}
          {% for t in recentTeachers %}
            <tr>
              <td class="fw-semibold">{{ t.name }}</td>
              <td class="text-muted">{{ t.subject }}</td>
              <td class="text-muted tz-date" style="font-size:0.85rem; white-space:nowrap" data-utc="{{ t.created_at }}">
                {{ t.created_at ? t.created_at|date("d/m/Y H:i") : '-' }}
              </td>
              <td class="text-muted tz-date" style="font-size:0.85rem; white-space:nowrap" data-utc="{{ t.updated_at }}">
                {{ t.updated_at ? t.updated_at|date("d/m/Y H:i") : '-' }}
              </td>
              <td>
                {% if t.is_active %}
                  <span class="badge text-bg-success" data-i18n="active">Active</span>
                {% else %}
                  <span class="badge text-bg-secondary" data-i18n="inactive">Inactive</span>
                {% endif %}
              </td>
              <td class="text-end">
                <a class="btn btn-sm btn-outline-secondary" href="{{ 'teachers_edit'|page({ id: t.id }) }}">
                  <i class="bi bi-pencil-square me-1"></i> <span data-i18n="btn_edit">Edit</span>
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#e74c6f';
  var success = '#22c55e';
  var muted = '#94a3b8';

  // ── Timeline Chart (Bar) ──
  var timelineLabels = [];
  var timelineCounts = [];
  {% for d in timelineData %}
    timelineLabels.push('{{ d.day|date("d/m") }}');
    timelineCounts.push({{ d.cnt }});
  {% endfor %}

  // Fill missing days with 0
  var today = new Date();
  if (timelineLabels.length === 0) {
    for (var i = 6; i >= 0; i--) {
      var day = new Date(today);
      day.setDate(day.getDate() - i);
      var dd = String(day.getDate()).padStart(2, '0');
      var mm = String(day.getMonth() + 1).padStart(2, '0');
      timelineLabels.push(dd + '/' + mm);
      timelineCounts.push(0);
    }
  }

  new Chart(document.getElementById('timelineChart'), {
    type: 'bar',
    data: {
      labels: timelineLabels,
      datasets: [{
        label: 'Teachers',
        data: timelineCounts,
        backgroundColor: accent + 'cc',
        borderColor: accent,
        borderWidth: 2,
        borderRadius: 6,
        hoverBackgroundColor: accent,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1, color: muted },
          grid: { color: 'rgba(148,163,184,0.1)' }
        },
        x: {
          ticks: { color: muted },
          grid: { display: false }
        }
      }
    }
  });

  // ── Subject Distribution (Doughnut) ──
  var subjectLabels = [];
  var subjectCounts = [];
  var subjectColors = [
    '#e74c6f', '#3b82f6', '#22c55e', '#f59e0b', '#a855f7',
    '#06b6d4', '#ec4899', '#84cc16'
  ];
  {% for s in subjectData %}
    subjectLabels.push('{{ s.subject|e('js') }}');
    subjectCounts.push({{ s.cnt }});
  {% endfor %}

  new Chart(document.getElementById('subjectChart'), {
    type: 'doughnut',
    data: {
      labels: subjectLabels,
      datasets: [{
        data: subjectCounts,
        backgroundColor: subjectColors.slice(0, subjectLabels.length),
        borderWidth: 2,
        borderColor: 'transparent',
        hoverOffset: 8,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '60%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: muted,
            padding: 12,
            usePointStyle: true,
            pointStyleWidth: 10,
            font: { size: 11 }
          }
        }
      }
    }
  });

  // ── Active vs Inactive (Horizontal Bar) ──
  new Chart(document.getElementById('statusChart'), {
    type: 'bar',
    data: {
      labels: ['Active', 'Inactive'],
      datasets: [{
        data: [{{ teacherStats.active }}, {{ teacherStats.inactive }}],
        backgroundColor: [success + 'cc', muted + '88'],
        borderColor: [success, muted],
        borderWidth: 2,
        borderRadius: 8,
        barThickness: 30,
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: {
          beginAtZero: true,
          ticks: { stepSize: 1, color: muted },
          grid: { color: 'rgba(148,163,184,0.1)' }
        },
        y: {
          ticks: { color: muted, font: { weight: 'bold' } },
          grid: { display: false }
        }
      }
    }
  });

  // Apply saved timezone to new tz-date elements on this page
  var savedTz = localStorage.getItem('armuzz-tz') || '+7';
  if (typeof applyTimezone === 'function') applyTimezone(savedTz);
});
</script>
